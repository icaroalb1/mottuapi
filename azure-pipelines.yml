trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

jobs:
- job: build_and_deploy
  displayName: "Build, Test e Deploy"
  steps:
    - checkout: self

    - task: Bash@3
      displayName: 'Install OpenJDK 21 JDK'
      inputs:
        targetType: 'inline'
        script: |
          sudo apt update
          sudo apt install openjdk-21-jdk -y
          sudo update-alternatives --set java /usr/lib/jvm/java-21-openjdk-amd64/bin/java
          sudo update-alternatives --set javac /usr/lib/jvm/java-21-openjdk-amd64/bin/javac
          export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
          echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"

          export db_url_azure=$(db_url_azure)
          export db_user_azure=$(db_user_azure)
          export db_password_azure=$(db_password_azure)
          export dockerhub_username=$(dockerhub_username)
          export dockerhub_password=$(dockerhub_password) 


    - script: |
        mvn clean package
      displayName: "Build Maven"

    - script: mvn test
      displayName: "Run Tests"

    - script: |
        docker login -u $(dockerhub_username) -p $(dockerhub_password)
        docker build -t mottu-api .
        docker tag mottu-api $(dockerhub_username)/mottu-api:latest
        docker push $(dockerhub_username)/mottu-api:latest
      displayName: "Build & Push Docker"

    - script: |
        az container create -g $(RESOURCE_GROUP) --name myapp \
        --image $(ACR_NAME).azurecr.io/myimage:latest \
        --cpu 1 --memory 1.5 --ports 80 --dns-name-label myuniqueapp
      displayName: "Deploy ACI"